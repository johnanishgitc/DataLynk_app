import React, { useState } from 'react';
import {
  View,
  ScrollView,
  Modal,
  StyleSheet,
  Text,
  TouchableOpacity,
  Alert,
} from 'react-native';
import { useFocusEffect, useRouter, useLocalSearchParams } from 'expo-router';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useOrderEntry } from '../src/hooks/useOrderEntry';
import { useUser } from '../src/context/UserContext';
import { 
  OrderHeader,
  OrderForm,
  CustomerDetails,
  OrderDetails,
  SubmitButton,
  VoucherTypeList,
} from '../src/components/order';

import { LightweightCustomerList } from '../src/components/order/LightweightCustomerList';
import { LightweightItemList } from '../src/components/order/LightweightItemList';
// TEMPORARILY DISABLED FOR PERFORMANCE TESTING
// import { MasterDataLoader } from '../src/components/common/MasterDataLoader';
import { createOrderXmlRequest, escapeXmlValue } from '../src/utils/tallyXmlRequests';
import { API_CONFIG } from '../src/config/api';
import { apiService } from '../src/services/api';
import BarcodeScanner from '@/components/BarcodeScanner';
import * as Print from 'expo-print';
import { shareAsync } from 'expo-sharing';

export default function OrderEntryPage() {
  const { userData } = useUser();
  const router = useRouter();
  const params = useLocalSearchParams();
  
  
  const {
    // State
    selectedCustomer,
    customerName,
    customerPhone,
    customerMobile,
    customerEmail,
    customerAddress,
    customerGSTIN,
    customerContact,
    customerPaymentTerms,
    customerDeliveryTerms,
    customerNarration,
    itemDescription,
    selectedItemIndex,
    itemQuantity,
    itemRate,
    itemDiscountPercent,
    itemTaxPercent,
    itemValue,
    itemBatch,
    orderItems,
    orderDueDate,
    showItemDropdown,
    showCustomerDropdown,
    isLoading,
    loadingItems,
    loadingCustomers,
    itemList,
    customers,
    orderConfig,
    selectedCompany,
    voucherTypes,
    selectedVoucherType,
    isLoadingVoucherTypes,
    showVoucherTypeDropdown,
    
    // Refs
    quantityInputRef,
    amountInputRef,
    
    // Actions
    setCustomerName,
    setCustomerPhone,
    setCustomerMobile,
    setCustomerEmail,
    setCustomerAddress,
    setCustomerGSTIN,
    setCustomerContact,
    setCustomerPaymentTerms,
    setCustomerDeliveryTerms,
    setCustomerNarration,
    setItemDescription,
    setItemQuantity,
    setItemRate,
    setItemDiscountPercent,
    setItemTaxPercent,
    setItemValue,
    setItemBatch,
    setShowItemDropdown,
    setShowCustomerDropdown,
    setIsLoading,
    setOrderDueDate,
    setSelectedVoucherType,
    setShowVoucherTypeDropdown,
    
    // Handlers
    handleItemSelect,
    handleCustomerSelect,
    addItemToOrder,
    removeItemFromOrder,
    editItemInOrder,
    getTotalAmount,
    validateForm,
    focusOnField,
    clearForm,
    resetForm,
    handleBack,
    handleNavigation,
    
    // Utilities
    reloadMasterDataWithNewConfig,
  } = useOrderEntry();

  // Debug itemDescription state changes
  React.useEffect(() => {
    console.log('üîç itemDescription state changed to:', itemDescription);
  }, [itemDescription]);

  // Debug logging for voucher type state
  console.log('üîç Voucher Type State Debug:');
  console.log('Voucher Types:', voucherTypes);
  console.log('Selected Voucher Type:', selectedVoucherType);
  console.log('Is Loading Voucher Types:', isLoadingVoucherTypes);

  // Menu state
  const [showMenu, setShowMenu] = useState(false);
  // Barcode scanner
  const [isScannerVisible, setIsScannerVisible] = useState(false);
    
  // Handle barcode scan
  const handleBarcodeScan = (barcode: string) => {
    if (!barcode) return;
    
    // Extract item name and batch from barcode if it contains "|" delimiter
    // Format: "itemname|batch" -> extract "itemname" and "batch"
    let itemNameToSearch = barcode;
    let batchToSet = '';
    
    if (barcode.includes('|')) {
      const parts = barcode.split('|');
      itemNameToSearch = parts[0].trim();
      batchToSet = parts[1] ? parts[1].trim() : '';
    }
    
    // Search for item by name (case-insensitive)
    const foundItem = itemList.find(item => 
      item.name.toLowerCase().includes(itemNameToSearch.toLowerCase())
    );
    
    if (foundItem) {
      handleItemSelect(foundItem);
      // Set the batch if it was extracted from the barcode and batch tracking is enabled
      if (batchToSet && orderConfig.enableBatchTracking) {
        setItemBatch(batchToSet);
      }
    } else {
      Alert.alert('Error', `Item not found for: ${itemNameToSearch}`);
    }
  };
  const handleMenuPress = () => {
    setShowMenu(!showMenu);
  };

  const handleNavigationWithMenu = (route: string) => {
    setShowMenu(false);
    handleNavigation(route);
  };

  // Note: Removed automatic form reset on focus to preserve data when returning from customer details

  // Handle data returned from customer details screen
  useFocusEffect(
    React.useCallback(() => {
      const handleCustomerDetailsReturn = async () => {
        try {
          // Check for stored customer details from customer details screen
          const storedDetails = await AsyncStorage.getItem('temp_customer_details');
          if (storedDetails) {
            const customerDetails = JSON.parse(storedDetails);
            
            // Check if the data is recent (within last 30 seconds)
            const now = Date.now();
            if (now - customerDetails.timestamp < 30000) {
              // Update customer details from the stored data
              if (customerDetails.contact) setCustomerContact(customerDetails.contact);
              if (customerDetails.phone) setCustomerPhone(customerDetails.phone);
              if (customerDetails.mobile) setCustomerMobile(customerDetails.mobile);
              if (customerDetails.email) setCustomerEmail(customerDetails.email);
              if (customerDetails.address) setCustomerAddress(customerDetails.address);
              if (customerDetails.gstin) setCustomerGSTIN(customerDetails.gstin);
              if (customerDetails.paymentTerms) setCustomerPaymentTerms(customerDetails.paymentTerms);
              if (customerDetails.deliveryTerms) setCustomerDeliveryTerms(customerDetails.deliveryTerms);
              if (customerDetails.narration) setCustomerNarration(customerDetails.narration);
              
              // Clear the stored data to prevent re-processing
              await AsyncStorage.removeItem('temp_customer_details');
            }
          }
        } catch (error) {
          console.error('Error loading customer details:', error);
        }
      };
      
      handleCustomerDetailsReturn();
      return () => {
        // Cleanup
      };
    }, [])
  );

  // Handle data returned from item details screen
  useFocusEffect(
    React.useCallback(() => {
      const handleItemDetailsReturn = async () => {
        console.log('üîç Item details return handler running...');
        try {
          // Check for stored item description from item details screen
          const storedItemDetails = await AsyncStorage.getItem('temp_item_description');
          console.log('üîç Stored item details:', storedItemDetails);
          if (storedItemDetails) {
            const itemDetails = JSON.parse(storedItemDetails);
            
            // Check if the data is recent (within last 30 seconds)
            const now = Date.now();
            if (now - itemDetails.timestamp < 30000) {
              // Update the item description state
              setItemDescription(itemDetails.itemDescription);
              
              // Clear the stored data to prevent re-processing
              await AsyncStorage.removeItem('temp_item_description');
            }
          }
        } catch (error) {
          console.error('Error loading item details:', error);
        }
      };
      
      handleItemDetailsReturn();
      return () => {
        // Cleanup
      };
    }, [setItemDescription])
  );

  // Generate HTML for order PDF
  const generateOrderHTML = (orderData: any) => {
    const { orderNumber, customerName, customerAddress, customerGSTIN, customerContact, orderItems, totalAmount, dueDate, voucherType } = orderData;
    
    const itemsHtml = orderItems.map((item: any) => `
      <tr>
        <td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.quantity}</td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">‚Çπ${item.rate.toFixed(2)}</td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">‚Çπ${item.value.toFixed(2)}</td>
      </tr>
    `).join('');

    return `
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Order - ${orderNumber}</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              margin: 0;
              padding: 20px;
              background-color: #fff;
            }
            .header {
              text-align: center;
              margin-bottom: 30px;
              border-bottom: 2px solid #333;
              padding-bottom: 20px;
            }
            .company-name {
              font-size: 24px;
              font-weight: bold;
              color: #333;
              margin-bottom: 10px;
            }
            .order-title {
              font-size: 20px;
              color: #666;
              margin-bottom: 5px;
            }
            .order-number {
              font-size: 18px;
              font-weight: bold;
              color: #007AFF;
            }
            .order-details {
              display: flex;
              justify-content: space-between;
              margin-bottom: 30px;
            }
            .customer-info, .order-info {
              flex: 1;
              margin: 0 10px;
            }
            .section-title {
              font-size: 16px;
              font-weight: bold;
              color: #333;
              margin-bottom: 10px;
              border-bottom: 1px solid #ddd;
              padding-bottom: 5px;
            }
            .info-row {
              margin-bottom: 5px;
              font-size: 14px;
            }
            .label {
              font-weight: bold;
              color: #555;
            }
            .items-table {
              width: 100%;
              border-collapse: collapse;
              margin-bottom: 20px;
            }
            .items-table th {
              background-color: #f5f5f5;
              padding: 12px 8px;
              border: 1px solid #ddd;
              text-align: left;
              font-weight: bold;
              color: #333;
            }
            .items-table td {
              padding: 8px;
              border: 1px solid #ddd;
            }
            .total-section {
              text-align: right;
              margin-top: 20px;
            }
            .total-row {
              font-size: 16px;
              margin-bottom: 5px;
            }
            .total-amount {
              font-size: 20px;
              font-weight: bold;
              color: #333;
              border-top: 2px solid #333;
              padding-top: 10px;
              margin-top: 10px;
            }
            .footer {
              margin-top: 40px;
              text-align: center;
              font-size: 12px;
              color: #666;
              border-top: 1px solid #ddd;
              padding-top: 20px;
            }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="company-name">${selectedCompany?.company || 'Company Name'}</div>
            <div class="order-title">${voucherType}</div>
            <div class="order-number">Order #${orderNumber}</div>
          </div>

          <div class="order-details">
            <div class="customer-info">
              <div class="section-title">Customer Details</div>
              <div class="info-row"><span class="label">Name:</span> ${customerName}</div>
              <div class="info-row"><span class="label">Address:</span> ${customerAddress || 'N/A'}</div>
              <div class="info-row"><span class="label">GSTIN:</span> ${customerGSTIN || 'N/A'}</div>
              <div class="info-row"><span class="label">Contact:</span> ${customerContact || 'N/A'}</div>
            </div>
            
            <div class="order-info">
              <div class="section-title">Order Information</div>
              <div class="info-row"><span class="label">Order Date:</span> ${new Date().toLocaleDateString('en-GB')}</div>
              <div class="info-row"><span class="label">Due Date:</span> ${dueDate}</div>
              <div class="info-row"><span class="label">Order Type:</span> ${voucherType}</div>
            </div>
          </div>

          <table class="items-table">
            <thead>
              <tr>
                <th>Item Description</th>
                <th style="text-align: center;">Quantity</th>
                <th style="text-align: right;">Rate</th>
                <th style="text-align: right;">Amount</th>
              </tr>
            </thead>
            <tbody>
              ${itemsHtml}
            </tbody>
          </table>

          <div class="total-section">
            <div class="total-amount">Total Amount: ‚Çπ${parseFloat(totalAmount).toFixed(2)}</div>
          </div>

          <div class="footer">
            <p>Thank you for your business!</p>
            <p>Generated on ${new Date().toLocaleString('en-GB')}</p>
          </div>
        </body>
      </html>
    `;
  };

  // Generate and share order PDF
  const generateAndShareOrderPDF = async (orderData: any) => {
    try {
      const html = generateOrderHTML(orderData);
      const { uri } = await Print.printToFileAsync({ html });
      await shareAsync(uri, {
        UTI: '.pdf',
        mimeType: 'application/pdf'
      });
    } catch (error) {
      Alert.alert('PDF Error', `Failed to generate PDF: ${error instanceof Error ? error.message : String(error)}`);
    }
  };

  // Handle order submission
  const handleAddItemDetails = () => {
    if (selectedItemIndex !== null) {
      const selectedItem = itemList[selectedItemIndex];
      router.push({
        pathname: '/item-details',
        params: {
          itemName: selectedItem.name,
          itemDescription: itemDescription || '', // Use current description if available
        }
      });
    }
  };

  const handleSubmitOrder = async () => {
    if (!validateForm()) {
      return;
    }

    setIsLoading(true);
    
    try {
      if (!selectedCompany) {
        throw new Error('No company selected. Please select a company first.');
      }

      // Generate order number
      const orderNumber = `ORD-${Math.floor(Math.random() * 1000000).toString().padStart(6, '0')}`;
      
      // Use the order due date from the form - format as DD-MM-YYYY for Tally
      const dueDate = new Date(orderDueDate);
      const day = dueDate.getDate().toString().padStart(2, '0');
      const month = (dueDate.getMonth() + 1).toString().padStart(2, '0');
      const year = dueDate.getFullYear();
      const formattedDueDate = `${day}-${month}-${year}`;
      
      // Create Tally XML for order creation
      const tallyXml = createOrderXmlRequest({
        companyName: selectedCompany.company,
        orderNumber,
        customerName,
        customerGSTIN,
        customerAddress,
        customerContact,
        customerPhone,
        customerMobile,
        customerEmail,
        customerPaymentTerms,
        customerDeliveryTerms,
        customerNarration,
        // GST and Address related fields from selected customer
        customerStateName: selectedCustomer?.stateName,
        customerCountry: selectedCustomer?.country,
        customerGSTType: selectedCustomer?.gstType,
        customerMailingName: selectedCustomer?.mailingName,
        customerPincode: selectedCustomer?.pincode,
        orderItems,
        totalAmount: getTotalAmount(),
        dueDate: formattedDueDate,
        voucherType: selectedVoucherType?.name || orderConfig.voucherTypeName,
        saveAsOptional: orderConfig.saveAsOptional
      }, orderConfig.showCustomerAddresses);

      // Send order to Tally via API
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000);
      
      try {
        // Use proxy for web development, direct connection for mobile
        const isWeb = typeof window !== 'undefined';
        const isLocalhost = isWeb && (window?.location?.hostname === 'localhost' || window?.location?.hostname === '127.0.0.1');
        
        const apiUrl = isWeb && isLocalhost 
          ? 'http://localhost:3000/api/tally/tallydata'
          : `${API_CONFIG.BASE_URL}/api/tally/tallydata`;
        
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/xml',
            'Authorization': `Bearer ${userData?.token}`,
            'x-tallyloc-id': selectedCompany.tallyloc_id,
            'x-company': selectedCompany.company,
            'x-guid': selectedCompany.GUID,
          },
          body: tallyXml,
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);

        if (response.ok) {
          const responseText = await response.text();
          
          // Log the response from Tally
          console.log('=== TALLY XML RESPONSE ===');
          console.log('Response Status:', response.status);
          console.log('Response Text:', responseText);
          console.log('=== END TALLY XML RESPONSE ===');
          
          // Check if Tally actually created the order
          const createdMatch = responseText.match(/<CREATED>(\d+)<\/CREATED>/);
          const errorsMatch = responseText.match(/<ERRORS>(\d+)<\/ERRORS>/);
          const exceptionsMatch = responseText.match(/<EXCEPTIONS>(\d+)<\/EXCEPTIONS>/);
          
          const created = createdMatch ? parseInt(createdMatch[1]) : 0;
          const errors = errorsMatch ? parseInt(errorsMatch[1]) : 0;
          const exceptions = exceptionsMatch ? parseInt(exceptionsMatch[1]) : 0;
          
          if (created > 0) {
            // Success - show alert and conditionally prompt for PDF generation
            if (orderConfig.showOrderPdfShareOption) {
      const orderData = {
        companyName: selectedCompany?.company || '',
        orderNumber,
        customerName,
        customerGSTIN,
        customerAddress,
        customerContact,
        customerPhone,
        customerMobile,
        customerEmail,
        // GST and Address related fields from selected customer
        customerStateName: selectedCustomer?.stateName,
        customerCountry: selectedCustomer?.country,
        customerGSTType: selectedCustomer?.gstType,
        customerMailingName: selectedCustomer?.mailingName,
        customerPincode: selectedCustomer?.pincode,
        orderItems,
        totalAmount: getTotalAmount(),
        dueDate: formattedDueDate,
        voucherType: selectedVoucherType?.name || orderConfig.voucherTypeName,
        saveAsOptional: orderConfig.saveAsOptional
      };

      // Debug logging for voucher type in first order data creation
      console.log('üîç First Order Data Debug:');
      console.log('Selected Voucher Type:', selectedVoucherType);
      console.log('Selected Voucher Type Name:', selectedVoucherType?.name);
      console.log('Config Voucher Type Name:', orderConfig.voucherTypeName);
      console.log('Final Voucher Type:', orderData.voucherType);

              // Debug logging for voucher type
              console.log('üîç Order Data Debug:');
              console.log('Selected Voucher Type:', selectedVoucherType);
              console.log('Selected Voucher Type Name:', selectedVoucherType?.name);
              console.log('Config Voucher Type Name:', orderConfig.voucherTypeName);
              console.log('Final Voucher Type:', orderData.voucherType);

              // Check if we're in a web environment with window.confirm available
              if (typeof window !== 'undefined' && window.confirm && window.alert) {
                // Web environment - use window.confirm
                const shouldGeneratePDF = window.confirm(
                  `Order created successfully in Tally!\n\nOrder Number: ${orderNumber}\nTotal Amount: ‚Çπ${getTotalAmount()}\n\nWould you like to generate and share a PDF of this order?`
                );
                
                if (shouldGeneratePDF) {
                  // Generate and share PDF
                  await generateAndShareOrderPDF(orderData);
                }
                
                // Clear form after PDF generation or if user cancels
                clearForm();
              } else {
                // React Native environment - use Alert with buttons
                Alert.alert(
                  'Order Created Successfully!',
                  `Order Number: ${orderNumber}\nTotal Amount: ‚Çπ${getTotalAmount()}\n\nWould you like to generate and share a PDF of this order?`,
                  [
                    {
                      text: 'No',
                      style: 'cancel',
                      onPress: () => clearForm()
                    },
                    {
                      text: 'Yes',
                      onPress: async () => {
                        await generateAndShareOrderPDF(orderData);
                        clearForm();
                      }
                    }
                  ]
                );
              }
            } else {
              // PDF sharing option is disabled - just show success message and clear form
            if (typeof window !== 'undefined' && window.alert) {
              window.alert(`Order created successfully in Tally!\n\nOrder Number: ${orderNumber}\nTotal Amount: ‚Çπ${getTotalAmount()}`);
              } else {
                Alert.alert(
                  'Order Created Successfully!',
                  `Order Number: ${orderNumber}\nTotal Amount: ‚Çπ${getTotalAmount()}`
                );
              }
              clearForm();
            }
          } else {
            // Extract LINEERROR messages for better error reporting
            const lineErrors = responseText.match(/<LINEERROR>(.*?)<\/LINEERROR>/g);
            const errorMessages = lineErrors ? lineErrors.map(error => 
              error.replace(/<LINEERROR>|<\/LINEERROR>/g, '').trim()
            ) : [];
            
            let errorMessage = `Tally could not create the order.\n\nCreated: ${created}\nErrors: ${errors}\nExceptions: ${exceptions}`;
            
            if (errorMessages.length > 0) {
              errorMessage += '\n\nSpecific Errors:\n' + errorMessages.join('\n');
            }
            
            if (typeof window !== 'undefined' && window.alert) {
              window.alert('Order Creation Failed\n\n' + errorMessage);
            }
          }
        } else {
          const errorText = await response.text();
          if (typeof window !== 'undefined' && window.alert) {
            window.alert(`Failed to create order in Tally. Status: ${response.status}\nError: ${errorText}`);
          }
        }
      } catch (fetchError: any) {
        clearTimeout(timeoutId);
        if (fetchError.name === 'AbortError') {
          if (typeof window !== 'undefined' && window.alert) {
            window.alert('Request timed out. Please try again.');
          }
        } else {
          throw fetchError;
        }
      }
    } catch (error: any) {
      if (typeof window !== 'undefined' && window.alert) {
        window.alert(`Failed to create order: ${error?.message || 'Unknown error'}\n\nPlease check your connection and try again.`);
      }
    } finally {
      setIsLoading(false);
    }
  };

  // Show loading if no company is selected
  if (!selectedCompany) {
    return (
      <View style={styles.container}>
        <View style={styles.loadingContainer}>
          <Text style={styles.loadingText}>Loading...</Text>
        </View>
      </View>
    );
  }

  return (
    // TEMPORARILY DISABLED FOR PERFORMANCE TESTING
    // <MasterDataLoader>
      <SafeAreaView style={styles.container} edges={['top', 'left', 'right', 'bottom']}>
        {/* Header */}
        <OrderHeader
          showMenu={showMenu}
          onMenuPress={handleMenuPress}
          onNavigation={handleNavigationWithMenu}
          selectedCompany={selectedCompany}
        />

        <View style={styles.contentContainer}>
          <ScrollView style={styles.scrollContent}>
            <View style={styles.content}>
            {/* Order Form */}
            <OrderForm
              selectedCustomer={selectedCustomer}
              selectedItemIndex={selectedItemIndex}
              itemQuantity={itemQuantity}
              itemRate={itemRate}
              itemDiscountPercent={itemDiscountPercent}
              itemTaxPercent={itemTaxPercent}
              itemValue={itemValue}
              itemBatch={itemBatch}
              orderItems={orderItems}
              orderConfig={orderConfig}
              itemList={itemList}
              customers={customers}
              voucherTypes={voucherTypes}
              selectedVoucherType={selectedVoucherType}
              isLoadingVoucherTypes={isLoadingVoucherTypes}
              onItemQuantityChange={setItemQuantity}
              onItemRateChange={setItemRate}
              onItemDiscountPercentChange={setItemDiscountPercent}
              onItemValueChange={setItemValue}
              onItemBatchChange={setItemBatch}
              onAddItemToOrder={addItemToOrder}
              onAddItemDetails={handleAddItemDetails}
              onRemoveItemFromOrder={removeItemFromOrder}
              onEditItemInOrder={editItemInOrder}
              onOpenItemDropdown={() => setShowItemDropdown(true)}
              onOpenCustomerDropdown={() => setShowCustomerDropdown(true)}
              onOpenVoucherTypeDropdown={() => setShowVoucherTypeDropdown(true)}
              onVoucherTypeSelect={(voucherType) => {
                console.log('üîç Voucher Type Selected:', voucherType);
                setSelectedVoucherType(voucherType);
              }}
              quantityInputRef={quantityInputRef}
              amountInputRef={amountInputRef}
              setIsScannerVisible={setIsScannerVisible}
            />


            {/* Order Details */}
            <OrderDetails
              orderDueDate={orderDueDate}
              showOrderDueDate={orderConfig.showOrderDueDate}
              onOrderDueDateChange={(date) => setOrderDueDate(date)}
            />

          </View>
          </ScrollView>

          {/* Fixed Action Buttons at Bottom */}
          <View style={styles.fixedActionContainer}>
          <TouchableOpacity 
            style={styles.addDetailsButton}
            onPress={() => {
              router.push({
                pathname: '/customer-details',
                params: {
                  contact: customerContact,
                  phone: customerPhone,
                  mobile: customerMobile,
                  email: customerEmail,
                  address: customerAddress,
                  gstin: customerGSTIN,
                  paymentTerms: customerPaymentTerms,
                  deliveryTerms: customerDeliveryTerms,
                  narration: customerNarration,
                }
              });
            }}
            activeOpacity={0.7}
          >
            <Text style={styles.addDetailsButtonText}>üìù Add details</Text>
          </TouchableOpacity>
          
            <SubmitButton
              isLoading={isLoading}
              onPress={handleSubmitOrder}
            />
          </View>
        </View>

        {/* Item Dropdown Modal */}
        <Modal
          visible={showItemDropdown}
          transparent={true}
          animationType="fade"
          onRequestClose={() => setShowItemDropdown(false)}
        >
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <View style={styles.modalHeader}>
              <Text style={styles.modalTitle}>Select Item</Text>
              <TouchableOpacity
                style={styles.closeButton}
                onPress={() => setShowItemDropdown(false)}
              >
                <Text style={styles.closeButtonText}>√ó</Text>
              </TouchableOpacity>
            </View>
            <LightweightItemList
              items={itemList}
              selectedCustomer={selectedCustomer}
              orderConfig={orderConfig}
              onItemSelect={handleItemSelect}
              loading={loadingItems}
            />
          </View>
        </View>
      </Modal>

      {/* Customer Dropdown Modal */}
      <Modal
        visible={showCustomerDropdown}
        transparent={true}
        animationType="fade"
        onRequestClose={() => setShowCustomerDropdown(false)}
      >
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <View style={styles.modalHeader}>
              <Text style={styles.modalTitle}>Select Customer</Text>
              <TouchableOpacity
                style={styles.closeButton}
                onPress={() => setShowCustomerDropdown(false)}
              >
                <Text style={styles.closeButtonText}>√ó</Text>
              </TouchableOpacity>
            </View>
            <LightweightCustomerList
              customers={customers}
              onCustomerSelect={handleCustomerSelect}
              loading={loadingCustomers}
            />
          </View>
        </View>
      </Modal>

      {/* Voucher Type Dropdown Modal */}
      <Modal
        visible={showVoucherTypeDropdown}
        transparent={true}
        animationType="fade"
        onRequestClose={() => setShowVoucherTypeDropdown(false)}
      >
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <VoucherTypeList
              voucherTypes={voucherTypes}
              selectedVoucherType={selectedVoucherType}
              onVoucherTypeSelect={setSelectedVoucherType}
              onClose={() => setShowVoucherTypeDropdown(false)}
            />
          </View>
        </View>
      </Modal>

      {/* Barcode Scanner */}
      {isScannerVisible && (
        <BarcodeScanner
          isVisible={isScannerVisible}
          onClose={() => {
            setIsScannerVisible(false)
            setShowItemDropdown(false)
          }}
          onScan={handleBarcodeScan}
        />
      )}
      </SafeAreaView>
      // TEMPORARILY DISABLED FOR PERFORMANCE TESTING
      // </MasterDataLoader>
    );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f8f9fa',
  },
  contentContainer: {
    flex: 1,
  },
  scrollContent: {
    flex: 1,
    paddingBottom: 120, // Space for fixed action container
  },
  fixedActionContainer: {
    position: 'absolute',
    bottom: 0,
    left: 0,
    right: 0,
    backgroundColor: '#f8f9fa',
    paddingHorizontal: 16,
    paddingVertical: 8,
    paddingBottom: 20, // Extra padding for safe area
    borderTopWidth: 1,
    borderTopColor: '#e9ecef',
    elevation: 8,
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: -2,
    },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    zIndex: 1000,
    flexDirection: 'row',
    gap: 12,
  },
  addDetailsButton: {
    flex: 1,
    backgroundColor: '#5D8277',
    paddingVertical: 8,
    paddingHorizontal: 16,
    borderRadius: 6,
    alignItems: 'center',
    justifyContent: 'center',
    minHeight: 36,
    elevation: 3,
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: 2,
    },
    shadowOpacity: 0.1,
    shadowRadius: 4,
  },
  addDetailsButtonText: {
    color: 'white',
    fontSize: 14,
    fontWeight: '600',
    lineHeight: 18,
  },
  content: {
    flex: 1,
    paddingTop: 0,
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'flex-start',
    alignItems: 'stretch',
  },
  modalContent: {
    backgroundColor: 'white',
    borderRadius: 12,
    width: '100%',
    height: '100%',
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#E0E0E0',
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: '600',
    color: '#333',
  },
  closeButton: {
    width: 30,
    height: 30,
    borderRadius: 15,
    backgroundColor: '#F0F0F0',
    alignItems: 'center',
    justifyContent: 'center',
  },
  closeButtonText: {
    fontSize: 18,
    fontWeight: '600',
    color: '#666',
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  loadingText: {
    fontSize: 16,
    color: '#666',
  },
});
